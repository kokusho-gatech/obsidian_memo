app:
  description: ç‰©ä»¶ã‚«ãƒ†ã‚´ãƒªã¨ã‚¸ãƒ£ãƒƒã‚¯ã‚¹åŸºæº–ã§ã®åˆ©å›ã‚Šã€ä»•å…¥ã‚Œå¯å¦åˆ¤å®šã€NGä¼šç¤¾ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€è£œå¡«è²»ç”¨ã®å¯å¦ãŒã‚ã‹ã‚Šã¾ã™ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç‰ˆï¼‰
  icon: ğŸ¦
  icon_background: '#D1E9FF'
  mode: workflow
  name: ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç‰ˆã€‘ä»•å…¥åˆ¤å®š_ver3.0_å…¨å›½å¯¾å¿œ
  use_icon_as_answer_icon: false

dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/gemini:0.2.7@b8a04c0155eb3b9d43ed1199b4387e7f67ef75ad63fcec466eab31a726e2c3a0
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/bedrock:0.0.25@a1f0f4842b4862db63f1194bdca9cf9b0e00543ef0a21dbfcb383376ec0b4faa

kind: app
version: 0.3.0

workflow:
  conversation_variables: []
  
  # è¨­å®šå€¤ã®å¤–éƒ¨åŒ– - æ”¹å–„ç‚¹1: ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ã®ç’°å¢ƒå¤‰æ•°åŒ–
  environment_variables:
  # æ—¢å­˜ã®é‡‘èæ©Ÿé–¢åŸºæº–
  - description: æ¥½å¤©éŠ€è¡Œã®è©•ä¾¡åŸºæº–
    id: rakuten_ng_standard_id
    name: rakuten_ng_standard
    selector: [env, rakuten_ng_standard]
    value: 'æ¥½å¤©éŠ€è¡Œã§ã¯ã€ä¸‹è¨˜ã®ä»•å…¥åŸºæº–ã‚’è¨­ã‘ã¦ã„ã¾ã™ã€‚ä¸‹è¨˜ã«è©²å½“ã™ã‚‹å ´åˆã¯NG ã‚¨ãƒªã‚¢ï¼ˆæ±äº¬éƒ½23åŒºå¤–ã€åŸ¼ç‰çœŒã•ã„ãŸã¾å¸‚ã€æ±äº¬éƒ½åºœä¸­å¸‚ã€æ±äº¬éƒ½å…«ç‹å­å¸‚ã€ç¥å¥ˆå·çœŒè—¤æ²¢å¸‚ï¼‰æœ€å¯„é§…ã‹ã‚‰å¾’æ­©12åˆ†ä»¥ä¸Šã¯NGï¼ˆä½†ã—ã€ã‚¨ãƒªã‚¢ãŒè‰¯ã„å ´åˆã¯ãã®é™ã‚Šã§ã¯ãªã„ï¼‰å°‚æœ‰é¢ç©ãŒ18ã¡~100ã¡ã®ç¯„å›²ã‚’è¶…ãˆã‚‹å ´åˆ'
    value_type: string
    
  - description: ã‚¸ãƒ£ãƒƒã‚¯ã‚¹ã®è©•ä¾¡åŸºæº–
    id: jacks_ng_standard_id
    name: jacks_ng_standard
    selector: [env, jacks_ng_standard]
    value: 'ã‚¸ãƒ£ãƒƒã‚¯ã‚¹ã§ã®è©•ä¾¡åŸºæº–ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚ãƒ»é§…å¾’æ­©ï¼šå¾’æ­©15åˆ†ä»¥ä¸Šã¯ä¸€å¾‹NGãƒ»å°‚æœ‰é¢ç©ï¼šã‚¨ãƒªã‚¢3ã®18ã¡æœªæº€ã®éƒ¨å±‹ã¯NGãƒ»æ‰€åœ¨éšï¼šé˜²çŠ¯ã€è¦–è¦šã‚¹ãƒˆãƒ¬ã‚¹å¯¾ç­–ãªã—ã®1éšç‰©ä»¶ã¯NGãƒ»ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ã®æœ‰ç„¡ï¼šç·éšæ•°ãŒ3éšä»¥ä¸Šã«ã‚‚é–¢ã‚ã‚‰ãšã€ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ãŒãªã„å ´åˆã¯NG'
    value_type: string
    
  - description: ã‚ªãƒªãƒƒã‚¯ã‚¹éŠ€è¡Œã®è©•ä¾¡åŸºæº–
    id: orix_ng_standard_id
    name: orix_ng_standard
    selector: [env, orix_ng_standard]
    value: 'ã‚ªãƒªãƒƒã‚¯ã‚¹éŠ€è¡Œã§ã®è©•ä¾¡åŸºæº–ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚ãƒ»é§…å¾’æ­©ï¼šæœ€å¯„é§…ã‹ã‚‰15åˆ†ä»¥ä¸Šã¯NGãƒ»å°‚æœ‰é¢ç©ï¼š18ã¡ä»¥ä¸Š50ã¡æœªæº€ã¯OKãƒ»ç·æˆ¸æ•°ï¼šç®¡ç†äººå®¤é™¤ãã€ç·æˆ¸æ•°20æˆ¸æœªæº€ã¯NGãƒ»ç¯‰å¹´æ•°ï¼šç¯‰25å¹´ä»¥ä¸Šã¯NG'
    value_type: string
    
  - description: ã‚ªãƒªãƒƒã‚¯ã‚¹éŠ€è¡ŒNGä¼šç¤¾ãƒªã‚¹ãƒˆ
    id: orix_ng_company_id
    name: orix_ng_company
    selector: [env, orix_ng_company]
    value: 'ã‚ªãƒªãƒƒã‚¯ã‚¹éŠ€è¡Œã§ã¯ã€ä¸å‹•ç”£ä»²ä»‹ä¼šç¤¾ã‚„è³ƒè²¸ç®¡ç†ä¼šç¤¾ã€ã‚‚ã—ãã¯å»ºç‰©ç®¡ç†ä¼šç¤¾ã¨ã—ã¦æ¬¡ã®ä¼šç¤¾ã«å½“ã¦ã¯ã¾ã‚‹å ´åˆã¯è©•ä¾¡ãŒNGã§è¿”ã£ã¦ãã‚‹ãŸã‚ã€ä»•å…¥ã‚Œåˆ¤å®šã¯NGã«ãªã‚Šã¾ã™ã€‚'
    value_type: string
    
  # æ–°è¦è¿½åŠ ï¼šè¨­å®šå€¤ã®å¤–éƒ¨åŒ–
  - description: å¾’æ­©åˆ†æ•°ã®è­¦å‘Šé–¾å€¤ï¼ˆåˆ†ï¼‰
    id: walk_warning_threshold
    name: walk_warning_threshold
    selector: [env, walk_warning_threshold]
    value: '13'
    value_type: string
    
  - description: å¾’æ­©åˆ†æ•°ã®NGé–¾å€¤ï¼ˆåˆ†ï¼‰
    id: walk_ng_threshold
    name: walk_ng_threshold
    selector: [env, walk_ng_threshold]
    value: '15'
    value_type: string
    
  - description: ä¿®ç¹•ç©ç«‹è£œå¡«é‡‘é¡ï¼ˆå††ï¼‰
    id: repair_fund_compensation_amount
    name: repair_fund_compensation_amount
    selector: [env, repair_fund_compensation_amount]
    value: '300000'
    value_type: string
    
  - description: 3ç‚¹ãƒ¦ãƒ‹ãƒƒãƒˆå¼•å½“é‡‘é¡ï¼ˆå††ï¼‰
    id: unit_bath_allowance_amount
    name: unit_bath_allowance_amount
    selector: [env, unit_bath_allowance_amount]
    value: '200000'
    value_type: string
    
  - description: ç©ºå®¤æ‰‹å½“ã®æœˆæ•°å€ç‡
    id: vacancy_allowance_months
    name: vacancy_allowance_months
    selector: [env, vacancy_allowance_months]
    value: '3'
    value_type: string
    
  - description: ã‚µãƒ–ãƒªãƒ¼ã‚¹ç²—åˆ©ç‡
    id: sublease_profit_margin
    name: sublease_profit_margin
    selector: [env, sublease_profit_margin]
    value: '0.85'
    value_type: string
    
  - description: é€šå¸¸ç²—åˆ©ç‡
    id: normal_profit_margin
    name: normal_profit_margin
    selector: [env, normal_profit_margin]
    value: '0.9'
    value_type: string

  features:
    file_upload:
      enabled: false
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false

  graph:
    edges:
    # æ”¹å–„ç‚¹3: ã‚¨ãƒƒã‚¸ã®æ•´ç†ã¨ã‚³ãƒ¡ãƒ³ãƒˆåŒ–
    # ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼
    - id: start_to_structure
      source: workflow_start
      sourceHandle: source
      target: property_info_structurer
      targetHandle: target
      type: custom
      
    - id: structure_to_extract
      source: property_info_structurer
      sourceHandle: source
      target: parameter_extractor
      targetHandle: target
      type: custom
      
    - id: extract_to_normalize
      source: parameter_extractor
      sourceHandle: source
      target: station_name_normalizer
      targetHandle: target
      type: custom
      
    - id: normalize_to_age_calc
      source: station_name_normalizer
      sourceHandle: source
      target: building_age_calculator
      targetHandle: target
      type: custom
      
    - id: age_calc_to_area_judge
      source: building_age_calculator
      sourceHandle: source
      target: area_judgment_branch
      targetHandle: target
      type: custom
      
    # é–¢æ±ã‚¨ãƒªã‚¢ãƒ•ãƒ­ãƒ¼
    - id: area_judge_kanto_to_station_rank
      source: area_judgment_branch
      sourceHandle: 'true'
      target: station_rank_retriever_kanto
      targetHandle: target
      type: custom
      
    - id: station_rank_to_yield
      source: station_rank_retriever_kanto
      sourceHandle: source
      target: yield_calculator_kanto
      targetHandle: target
      type: custom
      
    # ãã®ä»–ã‚¨ãƒªã‚¢ãƒ•ãƒ­ãƒ¼
    - id: area_judge_other_to_station_rank
      source: area_judgment_branch
      sourceHandle: 'false'
      target: station_rank_retriever_other
      targetHandle: target
      type: custom
      
    # ç‰©ä»¶åˆ¤å®šãƒ•ãƒ­ãƒ¼
    - id: yield_to_property_judge
      source: yield_calculator_kanto
      sourceHandle: source
      target: property_attribute_validator
      targetHandle: target
      type: custom
      
    # ä¼šç¤¾åˆ¤å®šãƒ•ãƒ­ãƒ¼ï¼ˆçµ±åˆï¼‰
    - id: property_to_company
      source: property_attribute_validator
      sourceHandle: source
      target: company_validator_unified
      targetHandle: target
      type: custom
      
    # è£œå¡«è²»ç”¨è¨ˆç®—ãƒ•ãƒ­ãƒ¼
    - id: company_to_compensation
      source: company_validator_unified
      sourceHandle: source
      target: compensation_calculator
      targetHandle: target
      type: custom
      
    # æœ€çµ‚çµæœçµ±åˆ
    - id: compensation_to_final
      source: compensation_calculator
      sourceHandle: source
      target: final_result_aggregator
      targetHandle: target
      type: custom
      
    - id: final_to_end
      source: final_result_aggregator
      sourceHandle: source
      target: workflow_end
      targetHandle: target
      type: custom

    nodes:
    # æ”¹å–„ç‚¹2: æ„å‘³ã®ã‚ã‚‹ãƒãƒ¼ãƒ‰åã¸ã®å¤‰æ›´
    
    # 1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹
    - data:
        desc: 'supplier by renosyã®æŸ»å®š or äº¤æ¸‰ç”»é¢ã‹ã‚‰ç‰©ä»¶æƒ…å ±éƒ¨åˆ†ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚é–¢æ±ç‰©ä»¶é™å®šã§åˆ©å›ã‚Šã¨ç‰©ä»¶ã‚«ãƒ†ã‚´ãƒªã®åˆ¤å®šãŒã§ãã¾ã™ã€‚'
        title: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹
        type: start
        variables:
        - label: article_info
          max_length: 999999
          required: true
          type: paragraph
          variable: article_info
      height: 181
      id: workflow_start
      position: {x: -3362, y: 112}
      type: custom
      width: 244

    # 2. ç‰©ä»¶æƒ…å ±æ§‹é€ åŒ–ï¼ˆæ”¹å–„ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
    - data:
        desc: å…¥åŠ›ã•ã‚ŒãŸéæ§‹é€ åŒ–ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¨™æº–ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
        model:
          completion_params:
            temperature: 0.3
          mode: chat
          name: gemini-2.5-flash
          provider: langgenius/gemini/google
        prompt_template:
        - id: system_prompt
          role: system
          text: |
            ã‚ãªãŸã¯ä¸å‹•ç”£ç‰©ä»¶æƒ…å ±ã®æ§‹é€ åŒ–å°‚é–€AIã§ã™ã€‚
            å…¥åŠ›ã•ã‚ŒãŸæƒ…å ±ã‚’ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦æ•´ç†ã—ã¦ãã ã•ã„ã€‚
            è¨˜è¼‰ãŒãªã„é …ç›®ã«ã¤ã„ã¦ã¯"ä¸æ˜"ã§å€¤ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
            
            # å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            **ğŸ’‰æŠ½å‡ºã—ãŸç‰©ä»¶æƒ…å ±ğŸ’‰**
            <details>
            ç‰©ä»¶åï¼š{å€¤}
            æ‰€åœ¨åœ°ï¼š{å€¤}
            ã‚¨ãƒªã‚¢ï¼š{æ‰€åœ¨åœ°ã‹ã‚‰ã€"é–¢æ±"or"é–¢è¥¿"or"ä¹å·"or"æ±åŒ—"ã®ã„ãšã‚Œã‹ã‚’åˆ¤å®š}
            æœ€å¯„é§…ï¼‘ï¼š{å€¤}é§…
            æœ€å¯„é§…ï¼‘ã¾ã§ã®å¾’æ­©åˆ†æ•°ï¼š{å€¤}
            æœ€å¯„é§…ï¼’ï¼š{å€¤}é§…ï¼ˆãªã„å ´åˆã¯"ä¸æ˜"ï¼‰
            æœ€å¯„é§…ï¼’ã¾ã§ã®å¾’æ­©åˆ†æ•°ï¼š{å€¤}ï¼ˆãªã„å ´åˆã¯æŠ½å‡ºã—ãªã„ï¼‰
            æ‰€åœ¨éšï¼š{å€¤}
            åœ°ä¸Šéšå±¤ï¼š{å€¤}
            å»ºç‰©æ§‹é€ ï¼š{å€¤}
            ç·æˆ¸æ•°ï¼š{å€¤}
            ç¯‰å¹´æœˆï¼š{å€¤}å¹´{å€¤}æœˆ
            å°‚æœ‰é¢ç©ï¼š{å€¤}ã¡
            ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿æœ‰ç„¡ï¼š{ã‚ã‚Š/ãªã—/æœªæŒ‡å®š}
            å®¤å†…æ´—æ¿¯æ©Ÿç½®ãå ´æœ‰ç„¡ï¼š{ã‚ã‚Š/ãªã—/æœªæŒ‡å®š}
            ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯æœ‰ç„¡ï¼š{ã‚ã‚Š/ãªã—/æœªæŒ‡å®š}
            ãƒã‚¹ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ï¼š{å€¤}
            ä»²ä»‹ä¼šç¤¾åï¼š{å€¤}
            ç¾æ³ï¼š{å€¤}
            ã‚µãƒ–ãƒªãƒ¼ã‚¹ä¼šç¤¾åï¼š{å€¤}
            å»ºç‰©ç®¡ç†ä¼šç¤¾åï¼š{å€¤}
            è³ƒæ–™ï¼š{å€¤}å††
            ä¿®ç¹•ç©ç«‹é‡‘ï¼š{å€¤}å††
            ç®¡ç†è²»ï¼š{å€¤}å††
            ãã®ä»–è²»ç”¨ï¼š{å€¤}å††
            å¿ƒç†çš„ç‘•ç–µï¼š{ã‚ã‚Š/ãªã—/ä¸æ˜}
            éƒ½é“åºœçœŒï¼š{å€¤}
            </details>
        - id: user_input
          role: user
          text: '{{#workflow_start.article_info#}}'
        title: ç‰©ä»¶æƒ…å ±æ§‹é€ åŒ–
        type: llm
      height: 325
      id: property_info_structurer
      position: {x: -2822, y: 112}
      type: custom
      width: 244

    # 3. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆæ”¹å–„ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šï¼‰
    - data:
        desc: æ§‹é€ åŒ–ã•ã‚ŒãŸæƒ…å ±ã‹ã‚‰å€‹åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        model:
          completion_params:
            temperature: 0.1
          mode: chat
          name: gemini-2.0-flash-lite
          provider: langgenius/gemini/google
        parameters:
        # åŸºæœ¬æƒ…å ±
        - description: ç‰©ä»¶å
          name: bldg_name
          required: false
          type: string
        - description: æ‰€åœ¨åœ°
          name: address
          required: false
          type: string
        - description: éƒ½é“åºœçœŒ
          name: prefecture
          required: true
          type: string
        - description: ã‚¨ãƒªã‚¢åŒºåˆ†
          name: area
          required: false
          type: string
          
        # é§…æƒ…å ±
        - description: æœ€å¯„ã‚Šé§…â‘ ï¼ˆé§…åã®ã¿ï¼‰
          name: station1
          required: false
          type: string
        - description: æœ€å¯„ã‚Šé§…â‘ ã¾ã§ã®å¾’æ­©åˆ†æ•°
          name: walk_minute_to_station1
          required: false
          type: number
        - description: æœ€å¯„ã‚Šé§…â‘¡ï¼ˆé§…åã®ã¿ã€ãªã„å ´åˆã¯"ä¸æ˜"ï¼‰
          name: station2
          required: false
          type: string
        - description: æœ€å¯„ã‚Šé§…â‘¡ã¾ã§ã®å¾’æ­©åˆ†æ•°
          name: walk_minute_to_station2
          required: false
          type: number
          
        # å»ºç‰©ä»•æ§˜
        - description: æ‰€åœ¨éš
          name: floor
          required: false
          type: number
        - description: åœ°ä¸Šéšå±¤
          name: stories_high
          required: false
          type: number
        - description: ç¯‰å¹´
          name: built_year
          required: false
          type: number
        - description: ç¯‰æœˆ
          name: built_month
          required: false
          type: number
        - description: å°‚æœ‰é¢ç©ï¼ˆã¡ï¼‰
          name: footprint
          required: false
          type: number
        - description: å»ºç‰©æ§‹é€ 
          name: building_structure
          required: false
          type: string
        - description: ç·æˆ¸æ•°
          name: total_rooms
          required: false
          type: number
          
        # è¨­å‚™ä»•æ§˜
        - description: ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ã®æœ‰ç„¡ï¼ˆã‚ã‚Š/ãªã—/æœªæŒ‡å®šï¼‰
          name: is_elevator_exist
          required: false
          type: string
        - description: å®¤å†…æ´—æ¿¯æ©Ÿç½®ãå ´ã®æœ‰ç„¡ï¼ˆã‚ã‚Š/ãªã—/æœªæŒ‡å®šï¼‰
          name: indoor_washing_machine_storage
          required: false
          type: string
        - description: ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ã®æœ‰ç„¡ï¼ˆã‚ã‚Š/ãªã—/æœªæŒ‡å®šï¼‰
          name: auto_lock
          required: false
          type: string
        - description: ãƒã‚¹ãƒ«ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—
          name: bathroom_type
          required: false
          type: string
          
        # ä¼šç¤¾æƒ…å ±
        - description: ä»²ä»‹ä¼šç¤¾å
          name: intermediary_company
          required: false
          type: string
        - description: ã‚µãƒ–ãƒªãƒ¼ã‚¹ä¼šç¤¾å
          name: subleasing_company
          required: false
          type: string
        - description: å»ºç‰©ç®¡ç†ä¼šç¤¾å
          name: building_management_company
          required: false
          type: string
          
        # è²¡å‹™æƒ…å ±
        - description: è³ƒæ–™ï¼ˆå††ï¼‰
          name: rental_price
          required: false
          type: number
        - description: ä¿®ç¹•ç©ç«‹é‡‘ï¼ˆå††ï¼‰
          name: repair_reserve_fund
          required: false
          type: number
        - description: ç®¡ç†è²»ï¼ˆå††ï¼‰
          name: administrative_cost
          required: false
          type: number
        - description: ãã®ä»–è²»ç”¨ï¼ˆå††ï¼‰
          name: other_cost
          required: false
          type: number
          
        # ãã®ä»–
        - description: ç¾æ³
          name: current_status
          required: false
          type: string
        - description: å¿ƒç†çš„ç‘•ç–µã®æœ‰ç„¡
          name: is_stigmatized
          required: false
          type: string
          
        query:
        - property_info_structurer
        - text
        title: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æŠ½å‡º
        type: parameter-extractor
      height: 89
      id: parameter_extractor
      position: {x: -2467, y: 112}
      type: custom
      width: 244

    # 4. é§…åæ­£è¦åŒ–ï¼ˆæ”¹å–„ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    - data:
        code: |
          def normalize_station_name(station_name: str) -> str:
              """é§…åã‚’æ¤œç´¢ç”¨ã«æ­£è¦åŒ–ã™ã‚‹å…±é€šé–¢æ•°"""
              if not station_name or station_name == "ä¸æ˜":
                  return "ä¸æ˜"
              
              # æ‹¬å¼§ã¨ãã®ä¸­èº«ã‚’é™¤å»
              import re
              station_name = re.sub(r'[ï¼ˆ(].*?[ï¼‰)]', '', station_name)
              
              # "é§…"ã‚’é™¤å»
              station_name = station_name.replace("é§…", "")
              
              # å‰å¾Œã®ç©ºç™½ã‚’é™¤å»
              return station_name.strip()

          def main(station1: str, station2: str) -> dict:
              try:
                  return {
                      "station1_normed": normalize_station_name(station1),
                      "station2_normed": normalize_station_name(station2)
                  }
              except Exception as e:
                  return {
                      "station1_normed": "ä¸æ˜",
                      "station2_normed": "ä¸æ˜",
                      "error": str(e)
                  }
        code_language: python3
        desc: é§…åã‚’æ¤œç´¢ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æ­£è¦åŒ–
        outputs:
          station1_normed:
            type: string
          station2_normed:
            type: string
          error:
            type: string
        title: é§…åæ­£è¦åŒ–
        type: code
        variables:
        - value_selector: [parameter_extractor, station1]
          variable: station1
        - value_selector: [parameter_extractor, station2]
          variable: station2
      height: 305
      id: station_name_normalizer
      position: {x: -1736, y: 112}
      type: custom
      width: 244

    # 5. ç¯‰å¹´æ•°è¨ˆç®—ï¼ˆæ”¹å–„ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
    - data:
        code: |
          def main(built_year: int, built_month: int) -> dict:
              try:
                  import datetime
                  
                  # å…¥åŠ›å€¤ã®æ¤œè¨¼
                  if not built_year or built_year <= 0:
                      return {"age_of_building": 0, "error": "ç¯‰å¹´ãŒç„¡åŠ¹ã§ã™"}
                  
                  if not built_month or built_month < 1 or built_month > 12:
                      built_month = 1  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                  
                  dt_now = datetime.datetime.now()
                  
                  # ç¯‰å¹´æ•°è¨ˆç®—
                  if dt_now.month >= built_month:
                      age = dt_now.year - built_year
                  else:
                      age = dt_now.year - built_year - 1
                  
                  return {
                      "age_of_building": max(0, age),  # è² ã®å€¤ã‚’é˜²æ­¢
                      "calculation_date": dt_now.strftime("%Y-%m-%d")
                  }
              except Exception as e:
                  return {
                      "age_of_building": 0,
                      "error": f"ç¯‰å¹´æ•°è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {str(e)}"
                  }
        code_language: python3
        desc: ç¯‰å¹´æœˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®ç¯‰å¹´æ•°ã‚’è¨ˆç®—
        outputs:
          age_of_building:
            type: number
          calculation_date:
            type: string
          error:
            type: string
        title: ç¯‰å¹´æ•°è¨ˆç®—
        type: code
        variables:
        - value_selector: [parameter_extractor, built_year]
          variable: built_year
        - value_selector: [parameter_extractor, built_month]
          variable: built_month
      height: 225
      id: building_age_calculator
      position: {x: -2104, y: 112}
      type: custom
      width: 244

    # 6. ã‚¨ãƒªã‚¢åˆ¤å®šåˆ†å²
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: is
            value: 'é–¢æ±'
            variable_selector: [parameter_extractor, area]
          logical_operator: and
        desc: ã‚¨ãƒªã‚¢ã«å¿œã˜ã¦å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’åˆ†å²
        title: ã‚¨ãƒªã‚¢åˆ¤å®šåˆ†å²
        type: if-else
      height: 125
      id: area_judgment_branch
      position: {x: -1400, y: 200}
      type: custom
      width: 244

    # 7. é§…ãƒ©ãƒ³ã‚¯å–å¾—ï¼ˆé–¢æ±ï¼‰
    - data:
        dataset_ids:
        - BZ0ZGECEQx1jlZ1gjNF/R3lQ7d7x289OUcyr2KwVtLaAYnteRJe7WOxYPx/ZABDS
        desc: é–¢æ±ã‚¨ãƒªã‚¢ã®é§…ãƒ©ãƒ³ã‚¯æƒ…å ±ã‚’å–å¾—
        multiple_retrieval_config:
          reranking_enable: false
          top_k: 4
        query_variable_selector: [station_name_normalizer, station1_normed]
        retrieval_mode: multiple
        title: é§…ãƒ©ãƒ³ã‚¯å–å¾—ï¼ˆé–¢æ±ï¼‰
        type: knowledge-retrieval
      height: 91
      id: station_rank_retriever_kanto
      position: {x: -238, y: 146}
      type: custom
      width: 244

    # 8. åˆ©å›ã‚Šè¨ˆç®—ï¼ˆé–¢æ±ï¼‰
    - data:
        code: |
          def main(rank_result: dict, age_of_building: int) -> dict:
              """åˆ©å›ã‚Šè¨ˆç®—ã®çµ±åˆå‡¦ç†"""
              try:
                  # é§…ãƒ©ãƒ³ã‚¯è§£æ
                  if not rank_result or len(rank_result) == 0:
                      return {
                          "rate": 0,
                          "rank": "NG",
                          "status": "FAIL",
                          "message": "é§…ãƒ©ãƒ³ã‚¯æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                      }
                  
                  row = str(rank_result[0]["content"])
                  rank = row.split(';')[2].split(': ')[1]
                  ap_rank_base = float(row.split(';')[3].split(': ')[1])
                  
                  # åˆ©å›ã‚Šå–å¾—ï¼ˆä»®ã®å®Ÿè£… - å®Ÿéš›ã¯ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹æ¤œç´¢ãŒå¿…è¦ï¼‰
                  base_rate = calculate_yield_by_rank_and_age(rank, age_of_building)
                  
                  return {
                      "rate": base_rate,
                      "rank": rank,
                      "ap_rank_base": ap_rank_base,
                      "status": "OK"
                  }
              except Exception as e:
                  return {
                      "rate": 0,
                      "rank": "NG",
                      "status": "FAIL",
                      "error": str(e)
                  }

          def calculate_yield_by_rank_and_age(rank: str, age: int) -> float:
              """ãƒ©ãƒ³ã‚¯ã¨ç¯‰å¹´æ•°ã‹ã‚‰åŸºæº–åˆ©å›ã‚Šã‚’ç®—å‡º"""
              base_rates = {
                  "S": 3.0, "A": 3.5, "B": 4.0, "C": 4.5, "D": 5.0
              }
              
              base_rate = base_rates.get(rank, 5.5)
              
              # ç¯‰å¹´æ•°ã«ã‚ˆã‚‹èª¿æ•´
              if age > 20:
                  base_rate += 0.5
              elif age > 15:
                  base_rate += 0.3
              elif age > 10:
                  base_rate += 0.1
              
              return base_rate
        code_language: python3
        desc: é§…ãƒ©ãƒ³ã‚¯ã¨ç¯‰å¹´æ•°ã‹ã‚‰åˆ©å›ã‚Šã‚’è¨ˆç®—
        outputs:
          rate:
            type: number
          rank:
            type: string
          ap_rank_base:
            type: number
          status:
            type: string
          message:
            type: string
          error:
            type: string
        title: åˆ©å›ã‚Šè¨ˆç®—ï¼ˆé–¢æ±ï¼‰
        type: code
        variables:
        - value_selector: [station_rank_retriever_kanto, result]
          variable: rank_result
        - value_selector: [building_age_calculator, age_of_building]
          variable: age_of_building
      height: 305
      id: yield_calculator_kanto
      position: {x: 1035, y: 146}
      type: custom
      width: 244

    # 9. é§…ãƒ©ãƒ³ã‚¯å–å¾—ï¼ˆãã®ä»–ã‚¨ãƒªã‚¢ï¼‰
    - data:
        dataset_ids:
        - BZ0ZGECEQx1jlZ1gjNF/R3lQ7d7x289OUcyr2KwVtLaAYnteRJe7WOxYPx/ZABDS
        desc: ãã®ä»–ã‚¨ãƒªã‚¢ã®é§…ãƒ©ãƒ³ã‚¯æƒ…å ±ã‚’å–å¾—
        multiple_retrieval_config:
          reranking_enable: false
          top_k: 4
        query_variable_selector: [station_name_normalizer, station1_normed]
        retrieval_mode: multiple
        title: é§…ãƒ©ãƒ³ã‚¯å–å¾—ï¼ˆãã®ä»–ï¼‰
        type: knowledge-retrieval
      height: 91
      id: station_rank_retriever_other
      position: {x: -238, y: 575}
      type: custom
      width: 244

    # 10. ç‰©ä»¶å±æ€§æ¤œè¨¼ï¼ˆçµ±åˆç‰ˆï¼‰
    - data:
        code: |
          # æ”¹å–„ç‚¹4: ç‰©ä»¶åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®çµ±åˆ
          def main(
              walk_minute_to_station1: int,
              station1_normed: str,
              stories_high: int,
              is_elevator_exist: str,
              indoor_washing_machine_storage: str,
              floor: int,
              building_structure: str,
              built_year: int,
              built_month: int,
              age_of_building: int,
              footprint: float,
              area: str,
              total_rooms: int,
              auto_lock: str,
              walk_warning_threshold: str,
              walk_ng_threshold: str
          ) -> dict:
              """ç‰©ä»¶å±æ€§ã®ç·åˆåˆ¤å®š"""
              try:
                  warnings = []
                  errors = []
                  
                  # è¨­å®šå€¤ã®å–å¾—
                  warn_threshold = int(walk_warning_threshold)
                  ng_threshold = int(walk_ng_threshold)
                  
                  # 1. å¾’æ­©åˆ†æ•°åˆ¤å®š
                  walk_result = validate_walking_distance(
                      walk_minute_to_station1, station1_normed, warn_threshold, ng_threshold
                  )
                  if walk_result["is_ng"] == 1:
                      errors.append(walk_result["message"])
                  elif walk_result["is_ng"] == 2:
                      warnings.append(walk_result["message"])
                  
                  # 2. ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼åˆ¤å®š
                  elevator_result = validate_elevator(stories_high, is_elevator_exist)
                  if elevator_result["is_ng"] == 1:
                      errors.append(elevator_result["message"])
                  elif elevator_result["is_ng"] == 2:
                      warnings.append(elevator_result["message"])
                  
                  # 3. å°‚æœ‰é¢ç©åˆ¤å®š
                  area_result = validate_footprint(footprint, area)
                  if area_result["is_ng"] == 1:
                      errors.append(area_result["message"])
                  elif area_result["is_ng"] == 2:
                      warnings.append(area_result["message"])
                  
                  # 4. ãã®ä»–ã®åˆ¤å®š...
                  
                  # ç·åˆåˆ¤å®š
                  if errors:
                      overall_result = "NGâŒ"
                  elif warnings:
                      overall_result = "è¦ç¢ºèªâ˜‘ï¸"
                  else:
                      overall_result = "OKâ­•ï¸"
                  
                  return {
                      "overall_result": overall_result,
                      "errors": errors,
                      "warnings": warnings,
                      "detail_results": {
                          "walk_distance": walk_result,
                          "elevator": elevator_result,
                          "footprint": area_result
                      }
                  }
              except Exception as e:
                  return {
                      "overall_result": "ã‚¨ãƒ©ãƒ¼",
                      "errors": [f"åˆ¤å®šå‡¦ç†ã‚¨ãƒ©ãƒ¼: {str(e)}"],
                      "warnings": [],
                      "detail_results": {}
                  }

          def validate_walking_distance(minutes: int, station: str, warn_threshold: int, ng_threshold: int) -> dict:
              """å¾’æ­©åˆ†æ•°ã®åˆ¤å®š"""
              if station == "ä¸æ˜":
                  return {"is_ng": 0, "message": ""}
              
              if minutes >= ng_threshold:
                  return {
                      "is_ng": 1,
                      "message": f"å¾’æ­©åˆ†æ•°ï¼šNGâŒ ({station}é§…ã€{minutes}åˆ† - {ng_threshold}åˆ†ä»¥ä¸Šã¯NG)"
                  }
              elif minutes >= warn_threshold:
                  return {
                      "is_ng": 2,
                      "message": f"å¾’æ­©åˆ†æ•°ï¼šè¦ç¢ºèªâ˜‘ï¸ ({station}é§…ã€{minutes}åˆ† - ä¾é ¼å¿…é ˆ)"
                  }
              else:
                  return {
                      "is_ng": 0,
                      "message": f"å¾’æ­©åˆ†æ•°ï¼šOKâ­•ï¸ ({station}é§…ã€{minutes}åˆ†)"
                  }

          def validate_elevator(stories: int, elevator: str) -> dict:
              """ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼æœ‰ç„¡ã®åˆ¤å®š"""
              if stories >= 3:
                  if elevator == "ãªã—":
                      return {
                          "is_ng": 1,
                          "message": f"ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ï¼šNGâŒ ({stories}éšå»ºã¦ã§ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ãªã—)"
                      }
                  elif elevator in ["æœªæŒ‡å®š", "ä¸æ˜"]:
                      return {
                          "is_ng": 2,
                          "message": f"ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ï¼šè¦ç¢ºèªâ˜‘ï¸ ({stories}éšå»ºã¦ã§ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼æƒ…å ±ä¸æ˜)"
                      }
              
              return {
                  "is_ng": 0,
                  "message": f"ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ï¼šOKâ­•ï¸ ({stories}éšã€{elevator})"
              }

          def validate_footprint(footprint: float, area: str) -> dict:
              """å°‚æœ‰é¢ç©ã®åˆ¤å®š"""
              if footprint < 18.0:
                  return {
                      "is_ng": 2,
                      "message": f"å°‚æœ‰é¢ç©ï¼šè¦ç¢ºèªâ˜‘ï¸ ({footprint}ã¡ - 18ã¡æœªæº€)"
                  }
              elif area == "é–¢æ±" and footprint >= 35.0:
                  return {
                      "is_ng": 2,
                      "message": f"å°‚æœ‰é¢ç©ï¼šè¦ç¢ºèªâ˜‘ï¸ ({footprint}ã¡ - é–¢æ±35ã¡ä»¥ä¸Š)"
                  }
              elif area != "é–¢æ±" and footprint >= 40.0:
                  return {
                      "is_ng": 2,
                      "message": f"å°‚æœ‰é¢ç©ï¼šè¦ç¢ºèªâ˜‘ï¸ ({footprint}ã¡ - é–¢æ±å¤–40ã¡ä»¥ä¸Š)"
                  }
              else:
                  return {
                      "is_ng": 0,
                      "message": f"å°‚æœ‰é¢ç©ï¼šOKâ­•ï¸ ({footprint}ã¡)"
                  }
        code_language: python3
        desc: ç‰©ä»¶å±æ€§ã®ç·åˆçš„ãªé©åˆæ€§åˆ¤å®š
        outputs:
          overall_result:
            type: string
          errors:
            type: array
          warnings:
            type: array
          detail_results:
            type: object
        title: ç‰©ä»¶å±æ€§æ¤œè¨¼
        type: code
        variables:
        - value_selector: [parameter_extractor, walk_minute_to_station1]
          variable: walk_minute_to_station1
        - value_selector: [station_name_normalizer, station1_normed]
          variable: station1_normed
        - value_selector: [parameter_extractor, stories_high]
          variable: stories_high
        - value_selector: [parameter_extractor, is_elevator_exist]
          variable: is_elevator_exist
        - value_selector: [parameter_extractor, indoor_washing_machine_storage]
          variable: indoor_washing_machine_storage
        - value_selector: [parameter_extractor, floor]
          variable: floor
        - value_selector: [parameter_extractor, building_structure]
          variable: building_structure
        - value_selector: [parameter_extractor, built_year]
          variable: built_year
        - value_selector: [parameter_extractor, built_month]
          variable: built_month
        - value_selector: [building_age_calculator, age_of_building]
          variable: age_of_building
        - value_selector: [parameter_extractor, footprint]
          variable: footprint
        - value_selector: [parameter_extractor, area]
          variable: area
        - value_selector: [parameter_extractor, total_rooms]
          variable: total_rooms
        - value_selector: [parameter_extractor, auto_lock]
          variable: auto_lock
        - value_selector: [env, walk_warning_threshold]
          variable: walk_warning_threshold
        - value_selector: [env, walk_ng_threshold]
          variable: walk_ng_threshold
      height: 400
      id: property_attribute_validator
      position: {x: 1400, y: 146}
      type: custom
      width: 244

    # 11. ä¼šç¤¾åˆ¤å®šï¼ˆçµ±åˆç‰ˆï¼‰- æ”¹å–„ç‚¹1: é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤
    - data:
        code: |
          def main(
              intermediary_company: str,
              building_management_company: str,
              subleasing_company: str,
              current_status: str
          ) -> dict:
              """ä¼šç¤¾åˆ¤å®šã®çµ±åˆå‡¦ç†"""
              try:
                  results = {}
                  
                  # 1. ä»²ä»‹ä¼šç¤¾åˆ¤å®š
                  if intermediary_company and intermediary_company != "ä¸æ˜":
                      results["intermediary"] = validate_company(
                          intermediary_company, "ä»²ä»‹ä¼šç¤¾", "intermediary"
                      )
                  else:
                      results["intermediary"] = {"status": "SKIP", "message": "ä»²ä»‹ä¼šç¤¾æƒ…å ±ãªã—"}
                  
                  # 2. å»ºç‰©ç®¡ç†ä¼šç¤¾åˆ¤å®š
                  if building_management_company and building_management_company != "ä¸æ˜":
                      results["building_management"] = validate_company(
                          building_management_company, "å»ºç‰©ç®¡ç†ä¼šç¤¾", "building_management"
                      )
                  else:
                      results["building_management"] = {"status": "SKIP", "message": "å»ºç‰©ç®¡ç†ä¼šç¤¾æƒ…å ±ãªã—"}
                  
                  # 3. ã‚µãƒ–ãƒªãƒ¼ã‚¹ä¼šç¤¾åˆ¤å®š
                  if subleasing_company and subleasing_company != "ä¸æ˜":
                      results["subleasing"] = validate_company(
                          subleasing_company, "ã‚µãƒ–ãƒªãƒ¼ã‚¹ä¼šç¤¾", "subleasing"
                      )
                  elif current_status == "ã‚µãƒ–ãƒªãƒ¼ã‚¹ä¸­":
                      results["subleasing"] = {"status": "WARNING", "message": "ã‚µãƒ–ãƒªãƒ¼ã‚¹ä¸­ã ãŒä¼šç¤¾åä¸æ˜"}
                  else:
                      results["subleasing"] = {"status": "SKIP", "message": "ã‚µãƒ–ãƒªãƒ¼ã‚¹ä¼šç¤¾æƒ…å ±ãªã—"}
                  
                  # ç·åˆåˆ¤å®š
                  overall_status = determine_overall_company_status(results)
                  
                  return {
                      "overall_status": overall_status,
                      "company_results": results,
                      "formatted_message": format_company_results(results)
                  }
              except Exception as e:
                  return {
                      "overall_status": "ERROR",
                      "company_results": {},
                      "formatted_message": f"ä¼šç¤¾åˆ¤å®šã‚¨ãƒ©ãƒ¼: {str(e)}"
                  }

          def validate_company(company_name: str, company_type: str, category: str) -> dict:
              """å€‹åˆ¥ä¼šç¤¾ã®åˆ¤å®šï¼ˆçµ±åˆã•ã‚ŒãŸæ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ï¼‰"""
              # å®Œå…¨ä¸€è‡´æ¤œç´¢ï¼ˆå®Ÿè£…ã¯çœç•¥ - å®Ÿéš›ã¯ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹æ¤œç´¢ï¼‰
              exact_match = search_ng_company_exact(company_name, category)
              
              if exact_match["found"]:
                  return {
                      "status": "NG",
                      "company_name": company_name,
                      "match_type": "å®Œå…¨ä¸€è‡´",
                      "matched_company": exact_match["matched_name"],
                      "message": f"{company_type}ï¼šNGâŒ ({exact_match['matched_name']}ã¨ä¸€è‡´)"
                  }
              
              # é¡ä¼¼æ¤œç´¢
              similar_match = search_ng_company_similar(company_name, category)
              
              if similar_match["found"]:
                  return {
                      "status": "WARNING",
                      "company_name": company_name,
                      "match_type": "é¡ä¼¼",
                      "matched_company": similar_match["matched_name"],
                      "message": f"{company_type}ï¼šè¦ç¢ºèªâ˜‘ï¸ (é¡ä¼¼: {similar_match['matched_name']})"
                  }
              
              return {
                  "status": "OK",
                  "company_name": company_name,
                  "match_type": "ãªã—",
                  "message": f"{company_type}ï¼šOKâ­•ï¸ (NGä¼šç¤¾ã«è©²å½“ãªã—)"
              }

          def search_ng_company_exact(company_name: str, category: str) -> dict:
              """NGä¼šç¤¾ã®å®Œå…¨ä¸€è‡´æ¤œç´¢ï¼ˆä»®å®Ÿè£…ï¼‰"""
              # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹æ¤œç´¢ã‚’è¡Œã†
              ng_companies = {
                  "intermediary": ["FRAT", "ã‚¹ãƒ—ãƒªãƒ³ã‚°ã‚¨ã‚¹ãƒ†ãƒ¼ãƒˆ", "ã‚¯ãƒ¬ã‚¨", "LEAF"],
                  "building_management": ["ãƒ—ãƒ¬ã‚¹ãƒˆã‚µãƒ¼ãƒ“ã‚¹"],
                  "subleasing": ["ãƒªãƒ–ãƒãƒƒã‚¯ã‚¹", "é’å±±ãƒ¡ã‚¤ãƒ³ãƒ©ãƒ³ãƒ‰"]
              }
              
              companies = ng_companies.get(category, [])
              for ng_company in companies:
                  if ng_company in company_name or company_name in ng_company:
                      return {"found": True, "matched_name": ng_company}
              
              return {"found": False, "matched_name": ""}

          def search_ng_company_similar(company_name: str, category: str) -> dict:
              """NGä¼šç¤¾ã®é¡ä¼¼æ¤œç´¢ï¼ˆä»®å®Ÿè£…ï¼‰"""
              # å®Ÿéš›ã®å®Ÿè£…ã§ã¯é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ã‚’è¡Œã†
              return {"found": False, "matched_name": ""}

          def determine_overall_company_status(results: dict) -> str:
              """ä¼šç¤¾åˆ¤å®šã®ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ±ºå®š"""
              for result in results.values():
                  if result.get("status") == "NG":
                      return "NGâŒ"
              
              for result in results.values():
                  if result.get("status") == "WARNING":
                      return "è¦ç¢ºèªâ˜‘ï¸"
              
              return "OKâ­•ï¸"

          def format_company_results(results: dict) -> str:
              """ä¼šç¤¾åˆ¤å®šçµæœã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
              messages = []
              for category, result in results.items():
                  if result.get("message"):
                      messages.append(result["message"])
              
              return "\n".join(messages)
        code_language: python3
        desc: ä¼šç¤¾åˆ¤å®šã®çµ±åˆå‡¦ç†ï¼ˆé‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šé™¤ç‰ˆï¼‰
        outputs:
          overall_status:
            type: string
          company_results:
            type: object
          formatted_message:
            type: string
        title: ä¼šç¤¾åˆ¤å®šï¼ˆçµ±åˆç‰ˆï¼‰
        type: code
        variables:
        - value_selector: [parameter_extractor, intermediary_company]
          variable: intermediary_company
        - value_selector: [parameter_extractor, building_management_company]
          variable: building_management_company
        - value_selector: [parameter_extractor, subleasing_company]
          variable: subleasing_company
        - value_selector: [parameter_extractor, current_status]
          variable: current_status
      height: 400
      id: company_validator_unified
      position: {x: 1800, y: 146}
      type: custom
      width: 244

    # 12. è£œå¡«è²»ç”¨è¨ˆç®—ï¼ˆçµ±åˆç‰ˆï¼‰
    - data:
        code: |
          def main(
              age_of_building: int,
              footprint: float,
              area: str,
              repair_reserve_fund: int,
              current_status: str,
              rental_price: int,
              bathroom_type: str,
              repair_fund_compensation_amount: str,
              unit_bath_allowance_amount: str,
              vacancy_allowance_months: str
          ) -> dict:
              """è£œå¡«è²»ç”¨ã®çµ±åˆè¨ˆç®—"""
              try:
                  # è¨­å®šå€¤ã®å–å¾—
                  repair_compensation = int(repair_fund_compensation_amount)
                  unit_bath_allowance = int(unit_bath_allowance_amount)
                  vacancy_months = int(vacancy_allowance_months)
                  
                  # 1. ä¿®ç¹•ç©ç«‹è£œå¡«é‡‘
                  repair_fund_result = calculate_repair_fund_compensation(
                      age_of_building, footprint, area, repair_reserve_fund, repair_compensation
                  )
                  
                  # 2. ç©ºå®¤æ‰‹å½“
                  vacancy_result = calculate_vacancy_allowance(
                      current_status, rental_price, vacancy_months
                  )
                  
                  # 3. 3ç‚¹ãƒ¦ãƒ‹ãƒƒãƒˆå¼•å½“é‡‘
                  unit_bath_result = calculate_unit_bath_allowance(
                      bathroom_type, unit_bath_allowance
                  )
                  
                  # 4. å¹³ç±³ã‚ãŸã‚Šä¿®ç¹•ç©ç«‹é‡‘
                  repair_per_sqm = calculate_repair_fund_per_sqm(footprint, repair_reserve_fund)
                  
                  # ç·è¨ˆç®—
                  total_compensation = (
                      repair_fund_result["amount"] + 
                      vacancy_result["amount"] + 
                      unit_bath_result["amount"]
                  )
                  
                  return {
                      "total_compensation": total_compensation,
                      "repair_fund_compensation": repair_fund_result,
                      "vacancy_allowance": vacancy_result,
                      "unit_bath_allowance": unit_bath_result,
                      "repair_fund_per_sqm": repair_per_sqm,
                      "formatted_message": format_compensation_message(
                          total_compensation, repair_fund_result, vacancy_result, 
                          unit_bath_result, repair_per_sqm, rental_price
                      )
                  }
              except Exception as e:
                  return {
                      "total_compensation": 0,
                      "error": f"è£œå¡«è²»ç”¨è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {str(e)}"
                  }

          def calculate_repair_fund_compensation(
              age: int, footprint: float, area: str, repair_fund: int, compensation_amount: int
          ) -> dict:
              """ä¿®ç¹•ç©ç«‹è£œå¡«é‡‘è¨ˆç®—"""
              if footprint == 0 or repair_fund == 0:
                  return {"amount": 0, "reason": "é¢ç©ã¾ãŸã¯ä¿®ç¹•ç©ç«‹é‡‘ãŒä¸æ˜"}
              
              repair_per_sqm = repair_fund / footprint
              
              # é–¢æ±ã‚¨ãƒªã‚¢ã®åŸºæº–
              if area == "é–¢æ±":
                  if age <= 10 and repair_per_sqm < 60:
                      return {
                          "amount": compensation_amount,
                          "reason": f"ç¯‰{age}å¹´ãƒ»{repair_per_sqm:.1f}å††/ã¡ï¼ˆ60å††æœªæº€ï¼‰"
                      }
                  elif age <= 20 and repair_per_sqm < 80:
                      return {
                          "amount": compensation_amount,
                          "reason": f"ç¯‰{age}å¹´ãƒ»{repair_per_sqm:.1f}å††/ã¡ï¼ˆ80å††æœªæº€ï¼‰"
                      }
              
              return {"amount": 0, "reason": "åŸºæº–ã«è©²å½“ã›ãš"}

          def calculate_vacancy_allowance(status: str, rent: int, months: int) -> dict:
              """ç©ºå®¤æ‰‹å½“è¨ˆç®—"""
              if status == "ç©ºå®¤":
                  return {
                      "amount": rent * months,
                      "reason": f"ç©ºå®¤ã®ãŸã‚è³ƒæ–™{months}ãƒ¶æœˆåˆ†"
                  }
              return {"amount": 0, "reason": "ç©ºå®¤ã§ã¯ãªã„"}

          def calculate_unit_bath_allowance(bath_type: str, allowance_amount: int) -> dict:
              """3ç‚¹ãƒ¦ãƒ‹ãƒƒãƒˆå¼•å½“é‡‘è¨ˆç®—"""
              if bath_type == "3ç‚¹ãƒ¦ãƒ‹ãƒƒãƒˆ":
                  return {
                      "amount": allowance_amount,
                      "reason": "3ç‚¹ãƒ¦ãƒ‹ãƒƒãƒˆä»•æ§˜"
                  }
              return {"amount": 0, "reason": "3ç‚¹ãƒ¦ãƒ‹ãƒƒãƒˆã§ã¯ãªã„"}

          def calculate_repair_fund_per_sqm(footprint: float, repair_fund: int) -> dict:
              """å¹³ç±³ã‚ãŸã‚Šä¿®ç¹•ç©ç«‹é‡‘è¨ˆç®—"""
              if footprint > 0 and repair_fund > 0:
                  return {
                      "value": repair_fund / footprint,
                      "footprint": footprint,
                      "total_fund": repair_fund
                  }
              return {"value": 0, "footprint": footprint, "total_fund": repair_fund}

          def format_compensation_message(
              total: int, repair: dict, vacancy: dict, unit_bath: dict, 
              repair_per_sqm: dict, rent: int
          ) -> str:
              """è£œå¡«è²»ç”¨çµæœã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
              message = f'<span style="color: white; background-color: #0066FF; padding: 2px 6px; border-radius: 4px;">ãã®ä»–è£œå¡«è²»ç”¨ã®ç™ºç”Ÿæœ‰ç„¡ğŸ’¸</span>\n'
              message += f'\nç™ºç”Ÿè²»ç”¨é¡ï¼š {total:,}å††\n'
              message += f'\n<details>\n'
              
              if repair["amount"] > 0:
                  message += f'\nãƒ»ä¿®ç¹•ç©ç«‹è£œå¡«é‡‘ï¼š{repair["amount"]:,}å††ãŒç™ºç”Ÿã—ã¾ã™ã€‚\n'
                  message += f'\nã€€â†’å‚è€ƒæƒ…å ±ï¼šå¹³ç±³ã‚ãŸã‚Šä¿®ç¹•ç©ç«‹é‡‘ï¼š{repair_per_sqm["value"]:.1f}å††\n'
              
              if unit_bath["amount"] > 0:
                  message += f'\nãƒ»ï¼“ç‚¹ãƒ¦ãƒ‹ãƒƒãƒˆå¼•å½“é‡‘ï¼š{unit_bath["amount"]:,}å††ãŒç™ºç”Ÿã—ã¾ã™ã€‚\n'
              
              if vacancy["amount"] > 0:
                  message += f'\nãƒ»ç©ºå®¤æ‰‹å½“ï¼š{vacancy["amount"]:,}å††ãŒç™ºç”Ÿã—ã¾ã™ã€‚\n'
                  message += f'\nã€€â†’å‚è€ƒæƒ…å ±ï¼šè³ƒæ–™ï¼š{rent:,}å††ã®3ãƒ¶æœˆåˆ†\n'
              
              message += f'\n</details>\n'
              return message
        code_language: python3
        desc: è£œå¡«è²»ç”¨ã®çµ±åˆè¨ˆç®—å‡¦ç†
        outputs:
          total_compensation:
            type: number
          repair_fund_compensation:
            type: object
          vacancy_allowance:
            type: object
          unit_bath_allowance:
            type: object
          repair_fund_per_sqm:
            type: object
          formatted_message:
            type: string
          error:
            type: string
        title: è£œå¡«è²»ç”¨è¨ˆç®—
        type: code
        variables:
        - value_selector: [building_age_calculator, age_of_building]
          variable: age_of_building
        - value_selector: [parameter_extractor, footprint]
          variable: footprint
        - value_selector: [parameter_extractor, area]
          variable: area
        - value_selector: [parameter_extractor, repair_reserve_fund]
          variable: repair_reserve_fund
        - value_selector: [parameter_extractor, current_status]
          variable: current_status
        - value_selector: [parameter_extractor, rental_price]
          variable: rental_price
        - value_selector: [parameter_extractor, bathroom_type]
          variable: bathroom_type
        - value_selector: [env, repair_fund_compensation_amount]
          variable: repair_fund_compensation_amount
        - value_selector: [env, unit_bath_allowance_amount]
          variable: unit_bath_allowance_amount
        - value_selector: [env, vacancy_allowance_months]
          variable: vacancy_allowance_months
      height: 400
      id: compensation_calculator
      position: {x: 2200, y: 146}
      type: custom
      width: 244

    # 13. æœ€çµ‚çµæœçµ±åˆ
    - data:
        code: |
          def main(
              property_validation: dict,
              company_validation: dict,
              compensation_calc: dict,
              yield_calc: dict,
              basic_info: str,
              sublease_profit_margin: str,
              normal_profit_margin: str
          ) -> dict:
              """æœ€çµ‚çµæœã®çµ±åˆã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
              try:
                  # åˆ©å›ã‚Šã¨æŸ»å®šé¡ã®è¨ˆç®—
                  appraisal_result = calculate_final_appraisal(
                      yield_calc, compensation_calc, sublease_profit_margin, normal_profit_margin
                  )
                  
                  # æœ€çµ‚HTMLã®ç”Ÿæˆ
                  final_html = generate_final_report(
                      property_validation,
                      company_validation,
                      compensation_calc,
                      appraisal_result,
                      basic_info
                  )
                  
                  return {
                      "final_result": final_html,
                      "property_status": property_validation.get("overall_result", "ä¸æ˜"),
                      "company_status": company_validation.get("overall_status", "ä¸æ˜"),
                      "appraisal_value": appraisal_result.get("appraised_value", 0),
                      "purchase_price": appraisal_result.get("purchase_price", 0),
                      "yield_rate": appraisal_result.get("yield_rate", 0),
                      "total_compensation": compensation_calc.get("total_compensation", 0)
                  }
              except Exception as e:
                  return {
                      "final_result": f"çµæœçµ±åˆã‚¨ãƒ©ãƒ¼: {str(e)}",
                      "error": str(e)
                  }

          def calculate_final_appraisal(yield_data: dict, compensation_data: dict, 
                                       sublease_margin: str, normal_margin: str) -> dict:
              """æœ€çµ‚æŸ»å®šé¡ãƒ»ä»•å…¥é¡ã®è¨ˆç®—"""
              # å®Ÿè£…ã¯å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‚è€ƒã«ç°¡ç•¥åŒ–
              try:
                  rate = yield_data.get("rate", 0)
                  if rate <= 0:
                      return {"appraised_value": 0, "purchase_price": 0, "yield_rate": 0}
                  
                  # ä»®ã®è¨ˆç®—ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã¯ã‚ˆã‚Šè¤‡é›‘ï¼‰
                  appraised_value = 10000000  # ä»®ã®å€¤
                  total_compensation = compensation_data.get("total_compensation", 0)
                  
                  # ç²—åˆ©ç‡ã®é©ç”¨
                  margin = float(sublease_margin) if "ã‚µãƒ–ãƒªãƒ¼ã‚¹" in str(compensation_data) else float(normal_margin)
                  purchase_price = int(appraised_value * margin + total_compensation)
                  
                  return {
                      "appraised_value": appraised_value,
                      "purchase_price": purchase_price,
                      "yield_rate": rate,
                      "profit_margin": margin
                  }
              except Exception as e:
                  return {"error": str(e)}

          def generate_final_report(property_val: dict, company_val: dict, 
                                   compensation_val: dict, appraisal_val: dict, basic_info: str) -> str:
              """æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã®HTMLç”Ÿæˆ"""
              html = '<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: #e1e5f2;">'
              html += '<h2 style="color: #ffffff;">ğŸ¦<b>ä»•å…¥åˆ¤å®šçµæœ</b>ğŸ¦</h2>'
              
              # ç‰©ä»¶æƒ…å ±åˆ¤å®š
              html += '<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 16px; background-color: #ffffff;">'
              html += f'<h3>ç‰©ä»¶æƒ…å ±åˆ¤å®šï¼š{property_val.get("overall_result", "ä¸æ˜")}</h3>'
              html += f'<p>ã‚¨ãƒ©ãƒ¼: {len(property_val.get("errors", []))}ä»¶</p>'
              html += f'<p>è­¦å‘Š: {len(property_val.get("warnings", []))}ä»¶</p>'
              html += '</div>'
              
              # ä¼šç¤¾åˆ¤å®š
              html += '<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 16px; background-color: #ffffff;">'
              html += f'<h3>ä¼šç¤¾åˆ¤å®šï¼š{company_val.get("overall_status", "ä¸æ˜")}</h3>'
              html += f'<p>{company_val.get("formatted_message", "")}</p>'
              html += '</div>'
              
              # è£œå¡«è²»ç”¨
              html += '<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 16px; background-color: #ffffff;">'
              html += compensation_val.get("formatted_message", "")
              html += '</div>'
              
              # æŸ»å®šçµæœ
              html += '<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 16px; background-color: #ffffff;">'
              html += f'<h3>æŸ»å®šçµæœ</h3>'
              html += f'<p>åˆ©å›ã‚Š: {appraisal_val.get("yield_rate", 0)}%</p>'
              html += f'<p>æœºä¸Šè©•ä¾¡é¡: {appraisal_val.get("appraised_value", 0):,}å††</p>'
              html += f'<p>æœºä¸Šä»•å…¥é¡: {appraisal_val.get("purchase_price", 0):,}å††</p>'
              html += '</div>'
              
              html += '</div>'
              html += basic_info
              
              return html
        code_language: python3
        desc: å…¨ã¦ã®åˆ¤å®šçµæœã‚’çµ±åˆã—ã¦æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        outputs:
          final_result:
            type: string
          property_status:
            type: string
          company_status:
            type: string
          appraisal_value:
            type: number
          purchase_price:
            type: number
          yield_rate:
            type: number
          total_compensation:
            type: number
          error:
            type: string
        title: æœ€çµ‚çµæœçµ±åˆ
        type: code
        variables:
        - value_selector: [property_attribute_validator, overall_result]
          variable: property_validation
        - value_selector: [company_validator_unified, overall_status]
          variable: company_validation
        - value_selector: [compensation_calculator, total_compensation]
          variable: compensation_calc
        - value_selector: [yield_calculator_kanto, rate]
          variable: yield_calc
        - value_selector: [property_info_structurer, text]
          variable: basic_info
        - value_selector: [env, sublease_profit_margin]
          variable: sublease_profit_margin
        - value_selector: [env, normal_profit_margin]
          variable: normal_profit_margin
      height: 400
      id: final_result_aggregator
      position: {x: 2600, y: 146}
      type: custom
      width: 244

    # 14. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ‚äº†
    - data:
        outputs:
        - value_selector: [final_result_aggregator, final_result]
          variable: result
        title: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ‚äº†
        type: end
      height: 89
      id: workflow_end
      position: {x: 3000, y: 164}
      type: custom
      width: 244 